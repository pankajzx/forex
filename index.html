<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Economic Calendar</title>
    <style>
      /* ===== Base ===== */
      body {
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        margin: 0;
        padding: 20px;
        color: #222;
      }
      h1 {
        text-align: center;
        margin-bottom: 25px;
        font-size: 32px;
        font-weight: 700;
        color: #1d3557;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }

      /* ===== Controls ===== */
      .controls {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
      }
      input,
      select,
      button {
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: #2a9d8f;
        box-shadow: 0 0 6px rgba(42, 157, 143, 0.3);
      }
      button {
        cursor: pointer;
        font-weight: 600;
      }

      button:hover {
        filter: brightness(0.9);
      }

      /* ===== Day Filters ===== */
      .day-filters {
        text-align: center;
        margin-bottom: 25px;
      }
      .day-filters button {
        margin: 0 5px;
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        background: #e9ecef;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        color: #495057;
        font-weight: 500;
      }
      .day-filters button.active {
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .day-filters button.active.all {
        background: #1d3557;
        color: white;
      }
      .day-filters button.active.yesterday {
        background: #6c757d;
        color: white;
      }
      .day-filters button.active.today {
        background: #ffca2c;
        color: #212529;
      }
      .day-filters button.active.tomorrow {
        background: #0f5132;
        color: white;
      }

      /* ===== Event Cards ===== */
      #output {
        display: grid;
        gap: 18px;
        max-width: 1100px;
        margin: 0 auto;
      }
      .event {
        background: #fff;
        border-radius: 14px;
        padding: 18px 22px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        line-height: 1.6;
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 6px solid transparent;
      }
      .event:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      }
      .event.past {
        background: #f8f9fa;
        border-left-color: #adb5bd;
        color: #555;
      }
      .event.upcoming {
        border-left-color: #1d3557;
        background: #edf2fb;
      }
      .event.today {
        background: #fff3cd;
        border-left-color: #ffca2c;
      }
      .event.yesterday {
        background: #f1f3f5;
        border-left-color: #6c757d;
      }
      .event.tomorrow {
        background: #d1e7dd;
        border-left-color: #0f5132;
      }

      /* ===== Event Inner ===== */
      .time {
        font-size: 14px;
        color: #495057;
        margin-bottom: 6px;
      }
      .event-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 6px;
        color: #1d3557;
      }
      .impact-high {
        color: #e63946;
        font-weight: bold;
      }
      .impact-medium {
        color: #f4a261;
        font-weight: bold;
      }
      .impact-low {
        color: #2a9d8f;
        font-weight: bold;
      }
      .impact-none {
        color: #6c757d;
        font-weight: bold;
      }
      .details {
        font-size: 14px;
        color: #333;
      }
      .event.upcoming {
        border-left-color: #1d3557;
        background: #cfe2ff; /* Light blue for upcoming */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <h1>ðŸ“… Economic Calendar â€” This Week (IST)</h1>

    <div class="controls">
      <input type="text" id="search" placeholder="Search by event title..." />
      <select id="countryFilter">
        <option value="">All Countries</option>
      </select>
      <select id="impactFilter">
        <option value="">All Impacts</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
      </select>
      <button onclick="load()">ðŸ”„ Refresh</button>
    </div>

    <div class="day-filters">
      <button onclick="setDayFilter('all')" class="active all">All Week</button>
      <button onclick="setDayFilter('yesterday')" class="yesterday">
        Yesterday
      </button>
      <button onclick="setDayFilter('today')" class="today">Today</button>
      <button onclick="setDayFilter('tomorrow')" class="tomorrow">
        Tomorrow
      </button>
    </div>

    <div id="output">Loadingâ€¦</div>

    <script>
      const API_URL =
        "https://api.allorigins.win/get?url=" +
        encodeURIComponent(
          "https://nfs.faireconomy.media/ff_calendar_thisweek.json"
        );

      let allEvents = [];
      let currentDayFilter = "all";

      function formatToIST(dateString) {
        try {
          const d = new Date(dateString);
          return new Intl.DateTimeFormat("en-IN", {
            weekday: "short",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            timeZone: "Asia/Kolkata",
          }).format(d);
        } catch {
          return dateString;
        }
      }

      function normalizeImpact(raw) {
        if (!raw) return { label: "None", cls: "impact-none" };
        const str = String(raw).toLowerCase();
        if (str.includes("high") || str === "3")
          return { label: "High", cls: "impact-high" };
        if (str.includes("medium") || str.includes("med") || str === "2")
          return { label: "Medium", cls: "impact-medium" };
        if (str.includes("low") || str === "1")
          return { label: "Low", cls: "impact-low" };
        return { label: raw, cls: "impact-none" };
      }

      function render(events) {
        const out = document.getElementById("output");
        out.innerHTML = "";
        if (!events.length) {
          out.textContent = "No events match your filters.";
          return;
        }

        const now = new Date();
        const futureEvents = events.filter(
          (ev) => ev.date && new Date(ev.date) > now
        );
        let nextUpcomingTime = futureEvents.length
          ? new Date(
              Math.min(...futureEvents.map((ev) => new Date(ev.date)))
            ).getTime()
          : null;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tzFormatter = new Intl.DateTimeFormat("en-CA", {
          timeZone: "Asia/Kolkata",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        const todayStr = tzFormatter.format(today);
        const yesterdayStr = tzFormatter.format(
          new Date(today.getTime() - 86400000)
        );
        const tomorrowStr = tzFormatter.format(
          new Date(today.getTime() + 86400000)
        );

        events.forEach((ev) => {
          const div = document.createElement("div");
          div.className = "event";

          const eventTime = ev.date ? new Date(ev.date).getTime() : null;

          // Determine status class
          if (eventTime && eventTime < now.getTime()) div.classList.add("past");
          else if (
            eventTime &&
            nextUpcomingTime &&
            eventTime === nextUpcomingTime
          )
            div.classList.add("upcoming");

          // Day filter color badge
          const evDateStr = ev.date
            ? tzFormatter.format(new Date(ev.date))
            : "";
          if (evDateStr === todayStr) div.classList.add("today");
          else if (evDateStr === yesterdayStr) div.classList.add("yesterday");
          else if (evDateStr === tomorrowStr) div.classList.add("tomorrow");

          const timeStr = ev.date ? formatToIST(ev.date) : "Time N/A";
          const title = ev.title ?? ev.event ?? "Untitled";
          const country = ev.country ?? ev.ccy ?? "â€”";
          const { label: impactLabel, cls: impactCls } = normalizeImpact(
            ev.impact ?? ev.importance
          );

          const actual = ev.actual ?? "â€”";
          const forecast = ev.forecast ?? "â€”";
          const previous = ev.previous ?? "â€”";

          div.innerHTML = `
        <div class="time">${timeStr} â€” <strong>${country}</strong></div>
        <div class="event-title">${title}</div>
        <div>Impact: <span class="${impactCls}">${impactLabel}</span></div>
        <div class="details">Actual: <strong>${actual}</strong> | Forecast: <strong>${forecast}</strong> | Previous: <strong>${previous}</strong></div>
      `;

          out.appendChild(div);
        });
      }

      function applyFilters() {
        const search = document.getElementById("search").value.toLowerCase();
        const country = document.getElementById("countryFilter").value;
        const impact = document.getElementById("impactFilter").value;

        let filtered = allEvents;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tzFormatter = new Intl.DateTimeFormat("en-CA", {
          timeZone: "Asia/Kolkata",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        const todayStr = tzFormatter.format(today);
        const yesterdayStr = tzFormatter.format(
          new Date(today.getTime() - 86400000)
        );
        const tomorrowStr = tzFormatter.format(
          new Date(today.getTime() + 86400000)
        );

        if (currentDayFilter !== "all") {
          filtered = filtered.filter((ev) => {
            if (!ev.date) return false;
            const dStr = tzFormatter.format(new Date(ev.date));
            if (currentDayFilter === "today") return dStr === todayStr;
            if (currentDayFilter === "yesterday") return dStr === yesterdayStr;
            if (currentDayFilter === "tomorrow") return dStr === tomorrowStr;
          });
        }

        filtered = filtered.filter((ev) => {
          const title = (ev.title ?? ev.event ?? "").toLowerCase();
          const countryMatch =
            !country || ev.country === country || ev.ccy === country;
          const { label: impactLabel } = normalizeImpact(
            ev.impact ?? ev.importance
          );
          const impactMatch = !impact || impactLabel === impact;
          return title.includes(search) && countryMatch && impactMatch;
        });

        render(filtered);
      }

      function setDayFilter(day) {
        currentDayFilter = day;
        document
          .querySelectorAll(".day-filters button")
          .forEach((btn) => btn.classList.remove("active"));
        const btn = document.querySelector(`.day-filters button.${day}`);
        if (btn) btn.classList.add("active");
        applyFilters();
      }

      async function load() {
        try {
          const res = await fetch(API_URL);
          const wrapper = await res.json();
          allEvents = JSON.parse(wrapper.contents);

          const countries = [
            ...new Set(
              allEvents.map((ev) => ev.country ?? ev.ccy).filter(Boolean)
            ),
          ];
          const countrySelect = document.getElementById("countryFilter");
          countrySelect.innerHTML =
            '<option value="">All Countries</option>' +
            countries.map((c) => `<option value="${c}">${c}</option>`).join("");

          applyFilters();
        } catch (err) {
          document.getElementById("output").textContent =
            "Error: " + err.message;
        }
      }

      document.getElementById("search").addEventListener("input", applyFilters);
      document
        .getElementById("countryFilter")
        .addEventListener("change", applyFilters);
      document
        .getElementById("impactFilter")
        .addEventListener("change", applyFilters);

      const now = new Date();
      // Filter future events
      const futureEvents = events.filter(
        (ev) => ev.date && new Date(ev.date) > now
      );
      let nextUpcomingTime = futureEvents.length
        ? new Date(
            Math.min(...futureEvents.map((ev) => new Date(ev.date)))
          ).getTime()
        : null;

      events.forEach((ev) => {
        const div = document.createElement("div");
        div.className = "event";

        const eventTime = ev.date ? new Date(ev.date).getTime() : null;

        // Mark past events
        if (eventTime && eventTime < now.getTime()) div.classList.add("past");
        // Highlight **next upcoming events** (all events at the same next time)
        else if (
          eventTime &&
          nextUpcomingTime &&
          eventTime === nextUpcomingTime
        )
          div.classList.add("upcoming");

        // Add day filters
        const tzFormatter = new Intl.DateTimeFormat("en-CA", {
          timeZone: "Asia/Kolkata",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        const evDateStr = ev.date ? tzFormatter.format(new Date(ev.date)) : "";
        const today = tzFormatter.format(new Date());
        const yesterday = tzFormatter.format(new Date(Date.now() - 86400000));
        const tomorrow = tzFormatter.format(new Date(Date.now() + 86400000));

        if (evDateStr === today) div.classList.add("today");
        else if (evDateStr === yesterday) div.classList.add("yesterday");
        else if (evDateStr === tomorrow) div.classList.add("tomorrow");

        // Inner HTML
        const timeStr = ev.date ? formatToIST(ev.date) : "Time N/A";
        const title = ev.title ?? ev.event ?? "Untitled";
        const country = ev.country ?? ev.ccy ?? "â€”";
        const { label: impactLabel, cls: impactCls } = normalizeImpact(
          ev.impact ?? ev.importance
        );
        const actual = ev.actual ?? "â€”";
        const forecast = ev.forecast ?? "â€”";
        const previous = ev.previous ?? "â€”";

        div.innerHTML = `
    <div class="time">${timeStr} â€” <strong>${country}</strong></div>
    <div class="event-title">${title}</div>
    <div>Impact: <span class="${impactCls}">${impactLabel}</span></div>
    <div class="details">Actual: <strong>${actual}</strong> | Forecast: <strong>${forecast}</strong> | Previous: <strong>${previous}</strong></div>
  `;

        out.appendChild(div);
      });

      load();
    </script>
  </body>
</html>
